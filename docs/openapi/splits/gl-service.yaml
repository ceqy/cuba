openapi: 3.0.3
info:
  title: GL Service API
  description: |
    CUBA ERP 总账服务 API

    提供会计分录创建、过账、冲销、查询等核心财务功能。

    ## gRPC 服务
    - 服务名: `fi.gl.v1.GlJournalEntryService`
    - 端口: 50060
  version: 1.0.0
  contact:
    name: CUBA Enterprise Team
    email: dev@cuba.local

servers:
  - url: http://localhost:8080
    description: 本地开发环境 (API Gateway)

tags:
  - name: 凭证管理
    description: 会计分录创建、更新、删除
  - name: 凭证过账
    description: 凭证过账和冲销
  - name: 凭证查询
    description: 凭证列表和明细查询
  - name: 期末处理
    description: 期末关账和结转
  - name: 外币处理
    description: 外币重估
  - name: 批量操作
    description: 批量创建和处理

paths:
  /api/v1/finance/gl/journal-entries:
    post:
      tags: [凭证管理]
      summary: 创建会计分录
      description: 创建新的会计分录（草稿或立即过账）
      operationId: CreateJournalEntry
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJournalEntryRequest'
            example:
              company_code: "1000"
              document_date: "2026-01-19"
              posting_date: "2026-01-19"
              document_type: "SA"
              reference: "INV-2026-001"
              header_text: "销售收入"
              line_items:
                - account: "110000"
                  debit_credit: "D"
                  amount: 11300
                  currency: "CNY"
                  text: "应收账款"
                - account: "600000"
                  debit_credit: "C"
                  amount: 10000
                  currency: "CNY"
                  text: "主营业务收入"
                - account: "220300"
                  debit_credit: "C"
                  amount: 1300
                  currency: "CNY"
                  text: "销项税"
              post_immediately: true
      responses:
        '200':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JournalEntryResponse'

  /api/v1/finance/gl/journal-entries/update:
    post:
      tags: [凭证管理]
      summary: 更新会计分录
      description: 更新会计分录（仅限未过账部分字段）
      operationId: UpdateJournalEntry
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateJournalEntryRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JournalEntryResponse'

  /api/v1/finance/gl/journal-entries/delete:
    post:
      tags: [凭证管理]
      summary: 删除会计分录
      description: 删除会计分录（仅限草稿状态）
      operationId: DeleteJournalEntry
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteJournalEntryRequest'
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JournalEntryResponse'

  /api/v1/finance/gl/journal-entries/post:
    post:
      tags: [凭证过账]
      summary: 过账凭证
      description: 将草稿凭证过账
      operationId: PostJournalEntry
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostJournalEntryRequest'
      responses:
        '200':
          description: 过账成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JournalEntryResponse'

  /api/v1/finance/gl/journal-entries/reverse:
    post:
      tags: [凭证过账]
      summary: 冲销凭证
      description: 冲销已过账的凭证（Full Reversal）
      operationId: ReverseJournalEntry
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReverseJournalEntryRequest'
      responses:
        '200':
          description: 冲销成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JournalEntryResponse'

  /api/v1/finance/gl/journal-entries/simulate:
    post:
      tags: [凭证管理]
      summary: 模拟过账
      description: 模拟过账效果，不实际过账
      operationId: SimulateJournalEntry
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SimulateJournalEntryRequest'
      responses:
        '200':
          description: 模拟成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationResponse'

  /api/v1/finance/gl/journal-entries/validate:
    post:
      tags: [凭证管理]
      summary: 验证凭证
      description: 验证凭证合法性
      operationId: ValidateJournalEntry
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateJournalEntryRequest'
      responses:
        '200':
          description: 验证完成
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResponse'

  /api/v1/finance/gl/journal-entries/park:
    post:
      tags: [凭证管理]
      summary: 挂账
      description: 挂账执行（Document Parking）
      operationId: ParkJournalEntry
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ParkJournalEntryRequest'
      responses:
        '200':
          description: 挂账成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ParkJournalEntryResponse'

  /api/v1/finance/gl/journal-entries/get:
    post:
      tags: [凭证查询]
      summary: 获取凭证详情
      description: 获取会计分录详细信息
      operationId: GetJournalEntry
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetJournalEntryRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JournalEntryDetail'

  /api/v1/finance/gl/journal-entries/list:
    post:
      tags: [凭证查询]
      summary: 查询凭证列表
      description: 查询会计分录列表
      operationId: ListJournalEntries
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ListJournalEntriesRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListJournalEntriesResponse'

  /api/v1/finance/gl/account-line-items:
    post:
      tags: [凭证查询]
      summary: 获取科目明细
      description: 获取科目余额明细（Analytical Request）
      operationId: GetAccountLineItems
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetAccountLineItemsRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountLineItemsResponse'

  /api/v1/finance/gl/parallel-ledger:
    post:
      tags: [凭证查询]
      summary: 并行会计分类账查询
      description: 查询并行会计分类账数据
      operationId: GetParallelLedgerData
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetParallelLedgerDataRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ParallelLedgerDataResponse'

  /api/v1/finance/gl/period-end/close:
    post:
      tags: [期末处理]
      summary: 执行期末关账
      description: 执行会计期间的期末关账
      operationId: ExecutePeriodEndClose
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecutePeriodEndCloseRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PeriodEndCloseResponse'

  /api/v1/finance/gl/period-end/carry-forward:
    post:
      tags: [期末处理]
      summary: 执行期间结转
      description: 执行期间余额结转
      operationId: CarryForwardBalances
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CarryForwardBalancesRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CarryForwardBalancesResponse'

  /api/v1/finance/gl/period-end/clear-open-items:
    post:
      tags: [期末处理]
      summary: 清账未清项目
      description: 清账未清项目（Clearing Open Items）
      operationId: ClearOpenItems
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClearOpenItemsRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClearOpenItemsResponse'

  /api/v1/finance/gl/foreign-currency/revaluate:
    post:
      tags: [外币处理]
      summary: 外币重估
      description: 获取外币重估建议并执行
      operationId: RevaluateForeignCurrency
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RevaluateForeignCurrencyRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevaluationResponse'

  /api/v1/finance/gl/batch/create:
    post:
      tags: [批量操作]
      summary: 批量创建凭证
      description: 批量创建多个会计分录
      operationId: BatchCreateJournalEntries
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchCreateJournalEntriesRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchCreateJournalEntriesResponse'

  /api/v1/finance/gl/batch/reverse:
    post:
      tags: [批量操作]
      summary: 批量冲销凭证
      description: 批量冲销多个会计分录
      operationId: BatchReverseJournalEntries
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchReverseJournalEntriesRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchReverseJournalEntriesResponse'

  /api/v1/finance/gl/batch/input-session:
    post:
      tags: [批量操作]
      summary: 创建批量输入会话
      description: 创建批量输入会话（Batch Input Session LSMW）
      operationId: CreateBatchInputSession
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBatchInputSessionRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchInputSessionResponse'

  /api/v1/finance/gl/print-preview:
    post:
      tags: [凭证管理]
      summary: 生成打印预览
      description: 生成凭证打印预览
      operationId: GeneratePrintPreview
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GeneratePrintPreviewRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeneratePrintPreviewResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    CreateJournalEntryRequest:
      type: object
      required:
        - company_code
        - document_date
        - posting_date
        - line_items
      properties:
        company_code:
          type: string
          description: 公司代码
        document_date:
          type: string
          format: date
          description: 凭证日期
        posting_date:
          type: string
          format: date
          description: 过账日期
        document_type:
          type: string
          description: 凭证类型（SA-销售、KR-采购等）
        reference:
          type: string
          description: 参考号
        header_text:
          type: string
          description: 抬头文本
        line_items:
          type: array
          items:
            $ref: '#/components/schemas/LineItem'
          description: 分录行
        post_immediately:
          type: boolean
          description: 是否立即过账
          default: false

    LineItem:
      type: object
      required:
        - account
        - debit_credit
        - amount
      properties:
        account:
          type: string
          description: 科目代码
        debit_credit:
          type: string
          enum: [D, C]
          description: 借贷标识（D-借方, C-贷方）
        amount:
          type: number
          format: double
          description: 金额
        currency:
          type: string
          description: 币种（ISO 4217）
          default: CNY
        cost_center:
          type: string
          description: 成本中心
        profit_center:
          type: string
          description: 利润中心
        text:
          type: string
          description: 行文本
        tax_code:
          type: string
          description: 税码

    JournalEntryResponse:
      type: object
      properties:
        entry_id:
          type: string
          description: 分录ID
        document_number:
          type: string
          description: 凭证号
        status:
          type: string
          enum: [DRAFT, POSTED, REVERSED, PARKED]
          description: 状态
        message:
          type: string
          description: 消息

    JournalEntryDetail:
      type: object
      properties:
        entry_id:
          type: string
        document_number:
          type: string
        company_code:
          type: string
        document_date:
          type: string
          format: date
        posting_date:
          type: string
          format: date
        document_type:
          type: string
        reference:
          type: string
        header_text:
          type: string
        status:
          type: string
        line_items:
          type: array
          items:
            $ref: '#/components/schemas/LineItemDetail'
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
        posted_at:
          type: string
          format: date-time
        posted_by:
          type: string

    LineItemDetail:
      type: object
      properties:
        line_number:
          type: integer
        account:
          type: string
        account_name:
          type: string
        debit_credit:
          type: string
        amount:
          type: number
        currency:
          type: string
        local_amount:
          type: number
        cost_center:
          type: string
        profit_center:
          type: string
        text:
          type: string

    UpdateJournalEntryRequest:
      type: object
      required:
        - entry_id
      properties:
        entry_id:
          type: string
        header_text:
          type: string
        reference:
          type: string

    DeleteJournalEntryRequest:
      type: object
      required:
        - entry_id
      properties:
        entry_id:
          type: string

    PostJournalEntryRequest:
      type: object
      required:
        - entry_id
      properties:
        entry_id:
          type: string

    ReverseJournalEntryRequest:
      type: object
      required:
        - entry_id
        - reversal_date
      properties:
        entry_id:
          type: string
          description: 原分录ID
        reversal_date:
          type: string
          format: date
          description: 冲销日期
        reversal_reason:
          type: string
          description: 冲销原因

    SimulateJournalEntryRequest:
      type: object
      properties:
        company_code:
          type: string
        document_date:
          type: string
          format: date
        posting_date:
          type: string
          format: date
        document_type:
          type: string
        line_items:
          type: array
          items:
            $ref: '#/components/schemas/LineItem'

    SimulationResponse:
      type: object
      properties:
        is_valid:
          type: boolean
          description: 是否有效
        errors:
          type: array
          items:
            type: string
          description: 错误列表
        warnings:
          type: array
          items:
            type: string
          description: 警告列表
        balance_impact:
          $ref: '#/components/schemas/BalanceImpact'

    BalanceImpact:
      type: object
      properties:
        total_debit:
          type: number
        total_credit:
          type: number
        is_balanced:
          type: boolean

    ValidationResponse:
      type: object
      properties:
        is_valid:
          type: boolean
        errors:
          type: array
          items:
            $ref: '#/components/schemas/ValidationError'
        warnings:
          type: array
          items:
            type: string

    ValidationError:
      type: object
      properties:
        field:
          type: string
        message:
          type: string
        code:
          type: string

    ValidateJournalEntryRequest:
      type: object
      properties:
        company_code:
          type: string
        document_date:
          type: string
          format: date
        posting_date:
          type: string
          format: date
        line_items:
          type: array
          items:
            $ref: '#/components/schemas/LineItem'

    ParkJournalEntryRequest:
      type: object
      required:
        - entry_id
      properties:
        entry_id:
          type: string

    ParkJournalEntryResponse:
      type: object
      properties:
        entry_id:
          type: string
        status:
          type: string
        message:
          type: string

    GetJournalEntryRequest:
      type: object
      required:
        - entry_id
      properties:
        entry_id:
          type: string

    ListJournalEntriesRequest:
      type: object
      properties:
        company_code:
          type: string
        from_date:
          type: string
          format: date
        to_date:
          type: string
          format: date
        status:
          type: string
        document_type:
          type: string
        page:
          type: integer
          default: 1
        page_size:
          type: integer
          default: 20

    ListJournalEntriesResponse:
      type: object
      properties:
        entries:
          type: array
          items:
            $ref: '#/components/schemas/JournalEntryDetail'
        total_count:
          type: integer
        page:
          type: integer
        page_size:
          type: integer

    GetAccountLineItemsRequest:
      type: object
      required:
        - company_code
        - account
      properties:
        company_code:
          type: string
        account:
          type: string
          description: 科目代码
        from_date:
          type: string
          format: date
        to_date:
          type: string
          format: date
        cost_center:
          type: string

    AccountLineItemsResponse:
      type: object
      properties:
        account:
          type: string
        account_name:
          type: string
        opening_balance:
          type: number
        closing_balance:
          type: number
        line_items:
          type: array
          items:
            $ref: '#/components/schemas/AccountLineItem'

    AccountLineItem:
      type: object
      properties:
        posting_date:
          type: string
          format: date
        document_number:
          type: string
        text:
          type: string
        debit:
          type: number
        credit:
          type: number
        balance:
          type: number

    GetParallelLedgerDataRequest:
      type: object
      properties:
        company_code:
          type: string
        ledger:
          type: string
        from_date:
          type: string
          format: date
        to_date:
          type: string
          format: date

    ParallelLedgerDataResponse:
      type: object
      properties:
        ledger:
          type: string
        entries:
          type: array
          items:
            $ref: '#/components/schemas/JournalEntryDetail'

    ExecutePeriodEndCloseRequest:
      type: object
      required:
        - company_code
        - fiscal_year
        - period
      properties:
        company_code:
          type: string
        fiscal_year:
          type: string
        period:
          type: string

    PeriodEndCloseResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        closed_period:
          type: string

    CarryForwardBalancesRequest:
      type: object
      required:
        - company_code
        - from_period
        - to_period
      properties:
        company_code:
          type: string
        from_period:
          type: string
        to_period:
          type: string

    CarryForwardBalancesResponse:
      type: object
      properties:
        success:
          type: boolean
        entries_created:
          type: integer
        message:
          type: string

    ClearOpenItemsRequest:
      type: object
      required:
        - company_code
        - account
      properties:
        company_code:
          type: string
        account:
          type: string
        clearing_date:
          type: string
          format: date
        item_ids:
          type: array
          items:
            type: string

    ClearOpenItemsResponse:
      type: object
      properties:
        success:
          type: boolean
        cleared_count:
          type: integer
        clearing_document:
          type: string

    RevaluateForeignCurrencyRequest:
      type: object
      required:
        - company_code
        - valuation_date
      properties:
        company_code:
          type: string
        valuation_date:
          type: string
          format: date
        accounts:
          type: array
          items:
            type: string
          description: 要重估的科目列表

    RevaluationResponse:
      type: object
      properties:
        success:
          type: boolean
        revaluation_entries:
          type: array
          items:
            $ref: '#/components/schemas/RevaluationEntry'
        total_gain_loss:
          type: number

    RevaluationEntry:
      type: object
      properties:
        account:
          type: string
        currency:
          type: string
        original_amount:
          type: number
        revalued_amount:
          type: number
        gain_loss:
          type: number

    BatchCreateJournalEntriesRequest:
      type: object
      required:
        - entries
      properties:
        entries:
          type: array
          items:
            $ref: '#/components/schemas/CreateJournalEntryRequest'

    BatchCreateJournalEntriesResponse:
      type: object
      properties:
        success_count:
          type: integer
        failed_count:
          type: integer
        results:
          type: array
          items:
            $ref: '#/components/schemas/BatchOperationResult'

    BatchReverseJournalEntriesRequest:
      type: object
      required:
        - entry_ids
        - reversal_date
      properties:
        entry_ids:
          type: array
          items:
            type: string
        reversal_date:
          type: string
          format: date
        reversal_reason:
          type: string

    BatchReverseJournalEntriesResponse:
      type: object
      properties:
        success_count:
          type: integer
        failed_count:
          type: integer
        results:
          type: array
          items:
            $ref: '#/components/schemas/BatchOperationResult'

    BatchOperationResult:
      type: object
      properties:
        entry_id:
          type: string
        success:
          type: boolean
        message:
          type: string
        document_number:
          type: string

    CreateBatchInputSessionRequest:
      type: object
      required:
        - session_name
      properties:
        session_name:
          type: string
        entries:
          type: array
          items:
            $ref: '#/components/schemas/CreateJournalEntryRequest'

    BatchInputSessionResponse:
      type: object
      properties:
        session_id:
          type: string
        session_name:
          type: string
        status:
          type: string
        total_entries:
          type: integer

    GeneratePrintPreviewRequest:
      type: object
      required:
        - entry_id
      properties:
        entry_id:
          type: string
        format:
          type: string
          enum: [PDF, HTML]
          default: PDF

    GeneratePrintPreviewResponse:
      type: object
      properties:
        content:
          type: string
          format: byte
          description: Base64 编码的文档内容
        content_type:
          type: string
        file_name:
          type: string
