# ğŸ‰ UMSKZ ç‰¹æ®Šæ€»è´¦æ ‡è¯† - é˜¶æ®µ 5 å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ æ‰§è¡Œæ¦‚è¿°

**å®Œæˆæ—¥æœŸ**: 2026-01-18
**æ‰§è¡Œé˜¶æ®µ**: é˜¶æ®µ 5 - gRPC Server æ›´æ–°
**çŠ¶æ€**: âœ… å®Œæˆ

---

## âœ… å®Œæˆå†…å®¹

### 1. Proto åˆ° Domain çš„è½¬æ¢é€»è¾‘æ›´æ–°

**æ–‡ä»¶**: `apps/fi/gl-service/src/api/grpc_server.rs`

#### æ›´æ–°å†…å®¹

**create_journal_entry æ–¹æ³•**:
```rust
// éªŒè¯ç‰¹æ®Šæ€»è´¦æ ‡è¯†
let special_gl_indicator = if l.special_gl_indicator.is_empty() {
    None
} else {
    // éªŒè¯ç‰¹æ®Šæ€»è´¦æ ‡è¯†æ˜¯å¦æœ‰æ•ˆ
    let gl_type = SpecialGlType::from_sap_code(&l.special_gl_indicator);
    if !gl_type.is_special() && !l.special_gl_indicator.is_empty() {
        return Err(Status::invalid_argument(
            format!("Invalid special_gl_indicator '{}' on line {}. Valid values: A (Bill of Exchange), F (Down Payment), V (Advance Payment), W (Bill Discount)",
                l.special_gl_indicator, l.line_item_number)
        ));
    }
    Some(l.special_gl_indicator)
};
```

**ç‰¹æ€§**:
- âœ… éªŒè¯ç‰¹æ®Šæ€»è´¦æ ‡è¯†æ˜¯å¦ä¸ºæœ‰æ•ˆå€¼ï¼ˆA, F, V, Wï¼‰
- âœ… ç©ºå­—ç¬¦ä¸²è‡ªåŠ¨è½¬æ¢ä¸º None
- âœ… æ— æ•ˆå€¼è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
- âœ… é”™è¯¯ä¿¡æ¯åŒ…å«è¡Œå·å’Œæœ‰æ•ˆå€¼åˆ—è¡¨

---

### 2. æ‰¹é‡æ“ä½œçš„è½¬æ¢é€»è¾‘æ›´æ–°

**batch_create_journal_entries æ–¹æ³•**:
```rust
// éªŒè¯ç‰¹æ®Šæ€»è´¦æ ‡è¯†
let special_gl_indicator = if l.special_gl_indicator.is_empty() {
    None
} else {
    let gl_type = SpecialGlType::from_sap_code(&l.special_gl_indicator);
    if !gl_type.is_special() && !l.special_gl_indicator.is_empty() {
        return Err(format!(
            "Invalid special_gl_indicator '{}' on line {}. Valid values: A, F, V, W",
            l.special_gl_indicator, l.line_item_number
        ));
    }
    Some(l.special_gl_indicator)
};
```

**ç‰¹æ€§**:
- âœ… æ‰¹é‡åˆ›å»ºæ—¶éªŒè¯æ¯ä¸ªè¡Œé¡¹ç›®
- âœ… å¤±è´¥æ—¶è¿”å›å…·ä½“é”™è¯¯ä¿¡æ¯
- âœ… ä¸å½±å“å…¶ä»–æˆåŠŸçš„å‡­è¯åˆ›å»º

---

### 3. æ¨¡æ‹Ÿå’Œæš‚å­˜æ“ä½œçš„è½¬æ¢é€»è¾‘æ›´æ–°

**simulate_journal_entry å’Œ park_journal_entry æ–¹æ³•**:
```rust
// éªŒè¯ç‰¹æ®Šæ€»è´¦æ ‡è¯†
let special_gl_indicator = if item.special_gl_indicator.is_empty() {
    None
} else {
    let gl_type = SpecialGlType::from_sap_code(&item.special_gl_indicator);
    if gl_type.is_special() || item.special_gl_indicator.is_empty() {
        Some(item.special_gl_indicator)
    } else {
        None // æ— æ•ˆçš„æ ‡è¯†ï¼Œå¿½ç•¥
    }
};
```

**ç‰¹æ€§**:
- âœ… æ¨¡æ‹Ÿæ—¶éªŒè¯ç‰¹æ®Šæ€»è´¦æ ‡è¯†
- âœ… æ— æ•ˆå€¼è‡ªåŠ¨å¿½ç•¥ï¼ˆä¸æŠ¥é”™ï¼‰
- âœ… ä¿è¯æ¨¡æ‹Ÿç»“æœçš„å‡†ç¡®æ€§

---

### 4. éªŒè¯æ–¹æ³•å¢å¼º

**validate_journal_entry æ–¹æ³•**:
```rust
// éªŒè¯ç‰¹æ®Šæ€»è´¦æ ‡è¯†
if !line.special_gl_indicator.is_empty() {
    let gl_type = SpecialGlType::from_sap_code(&line.special_gl_indicator);
    if !gl_type.is_special() {
        messages.push(crate::infrastructure::grpc::common::v1::ApiMessage {
            r#type: "error".to_string(),
            code: "INVALID_SPECIAL_GL".to_string(),
            message: format!(
                "æ— æ•ˆçš„ç‰¹æ®Šæ€»è´¦æ ‡è¯†: {}. æœ‰æ•ˆå€¼: A (ç¥¨æ®), F (é¢„ä»˜æ¬¾), V (é¢„æ”¶æ¬¾), W (ç¥¨æ®è´´ç°)",
                line.special_gl_indicator
            ),
            target: format!("line_{}", line.line_item_number),
        });
    }
}
```

**ç‰¹æ€§**:
- âœ… ç‹¬ç«‹çš„éªŒè¯æ–¹æ³•
- âœ… è¿”å›è¯¦ç»†çš„ä¸­æ–‡é”™è¯¯ä¿¡æ¯
- âœ… åŒ…å«æœ‰æ•ˆå€¼è¯´æ˜
- âœ… æŒ‡å®šé”™è¯¯è¡Œå·

---

### 5. Domain åˆ° Proto çš„è½¬æ¢é€»è¾‘

**map_to_detail å’Œ get_account_line_items æ–¹æ³•**:
```rust
special_gl_indicator: l.special_gl_indicator.to_sap_code().to_string(),
```

**ç‰¹æ€§**:
- âœ… ä½¿ç”¨ `to_sap_code()` æ–¹æ³•è½¬æ¢
- âœ… è‡ªåŠ¨å¤„ç† Normal ç±»å‹ï¼ˆè½¬æ¢ä¸ºç©ºå­—ç¬¦ä¸²ï¼‰
- âœ… ä¿è¯è¿”å›çš„æ˜¯æœ‰æ•ˆçš„ SAP ä»£ç 

---

## ğŸ“Š æ›´æ–°ç»Ÿè®¡

### ä»£ç å˜æ›´

| æ–¹æ³• | å˜æ›´ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| `create_journal_entry` | å¢å¼ºéªŒè¯ | æ·»åŠ ç‰¹æ®Šæ€»è´¦æ ‡è¯†éªŒè¯ |
| `simulate_journal_entry` | å¢å¼ºéªŒè¯ | æ·»åŠ ç‰¹æ®Šæ€»è´¦æ ‡è¯†éªŒè¯ |
| `park_journal_entry` | å¢å¼ºéªŒè¯ | æ·»åŠ ç‰¹æ®Šæ€»è´¦æ ‡è¯†éªŒè¯ |
| `batch_create_journal_entries` | å¢å¼ºéªŒè¯ | æ·»åŠ ç‰¹æ®Šæ€»è´¦æ ‡è¯†éªŒè¯ |
| `validate_journal_entry` | æ–°å¢éªŒè¯ | ç‹¬ç«‹çš„ç‰¹æ®Šæ€»è´¦æ ‡è¯†éªŒè¯ |
| `map_to_detail` | å·²å­˜åœ¨ | ä½¿ç”¨ `to_sap_code()` è½¬æ¢ |
| `get_account_line_items` | å·²å­˜åœ¨ | ä½¿ç”¨ `to_sap_code()` è½¬æ¢ |

### éªŒè¯è§„åˆ™

| è§„åˆ™ | è¯´æ˜ | é”™è¯¯å¤„ç† |
|------|------|----------|
| **æœ‰æ•ˆå€¼æ£€æŸ¥** | åªæ¥å— A, F, V, W | è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯ |
| **ç©ºå€¼å¤„ç†** | ç©ºå­—ç¬¦ä¸²è½¬æ¢ä¸º None | è‡ªåŠ¨å¤„ç† |
| **ç±»å‹è½¬æ¢** | ä½¿ç”¨ `from_sap_code()` | æ— æ•ˆå€¼è½¬æ¢ä¸º Normal |
| **é”™è¯¯ä¿¡æ¯** | åŒ…å«è¡Œå·å’Œæœ‰æ•ˆå€¼åˆ—è¡¨ | ä¾¿äºè°ƒè¯• |

---

## ğŸ’» ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åˆ›å»ºé¢„ä»˜æ¬¾å‡­è¯ï¼ˆæœ‰æ•ˆï¼‰

**è¯·æ±‚**:
```json
{
  "header": {
    "company_code": "1000",
    "fiscal_year": 2026,
    "posting_date": {...},
    "currency": "CNY"
  },
  "line_items": [
    {
      "line_item_number": 1,
      "gl_account": "1100",
      "debit_credit_indicator": "D",
      "amount_in_document_currency": {"value": "10000.00"},
      "special_gl_indicator": "F"  // é¢„ä»˜æ¬¾
    },
    {
      "line_item_number": 2,
      "gl_account": "2100",
      "debit_credit_indicator": "C",
      "amount_in_document_currency": {"value": "10000.00"}
    }
  ]
}
```

**å“åº”**:
```json
{
  "success": true,
  "document_reference": {
    "document_number": "1000000001",
    "company_code": "1000",
    "fiscal_year": 2026
  }
}
```

---

### ç¤ºä¾‹ 2: æ— æ•ˆçš„ç‰¹æ®Šæ€»è´¦æ ‡è¯†

**è¯·æ±‚**:
```json
{
  "line_items": [
    {
      "line_item_number": 1,
      "special_gl_indicator": "X"  // æ— æ•ˆå€¼
    }
  ]
}
```

**å“åº”**:
```json
{
  "code": 3,
  "message": "Invalid special_gl_indicator 'X' on line 1. Valid values: A (Bill of Exchange), F (Down Payment), V (Advance Payment), W (Bill Discount)"
}
```

---

### ç¤ºä¾‹ 3: éªŒè¯å‡­è¯

**è¯·æ±‚**:
```json
{
  "header": {...},
  "line_items": [
    {
      "line_item_number": 1,
      "special_gl_indicator": "Z"  // æ— æ•ˆå€¼
    }
  ]
}
```

**å“åº”**:
```json
{
  "is_valid": false,
  "messages": [
    {
      "type": "error",
      "code": "INVALID_SPECIAL_GL",
      "message": "æ— æ•ˆçš„ç‰¹æ®Šæ€»è´¦æ ‡è¯†: Z. æœ‰æ•ˆå€¼: A (ç¥¨æ®), F (é¢„ä»˜æ¬¾), V (é¢„æ”¶æ¬¾), W (ç¥¨æ®è´´ç°)",
      "target": "line_1"
    }
  ]
}
```

---

## ğŸ¯ éªŒè¯é€»è¾‘

### éªŒè¯æµç¨‹

```
1. æ¥æ”¶ Proto è¯·æ±‚
   â†“
2. æ£€æŸ¥ special_gl_indicator æ˜¯å¦ä¸ºç©º
   â†“
3. å¦‚æœä¸ä¸ºç©ºï¼Œä½¿ç”¨ SpecialGlType::from_sap_code() è½¬æ¢
   â†“
4. æ£€æŸ¥è½¬æ¢åçš„ç±»å‹æ˜¯å¦ä¸ºç‰¹æ®Šç±»å‹
   â†“
5. å¦‚æœæ— æ•ˆï¼Œè¿”å›é”™è¯¯æˆ–å¿½ç•¥ï¼ˆå–å†³äºæ–¹æ³•ï¼‰
   â†“
6. å¦‚æœæœ‰æ•ˆï¼Œä¼ é€’ç»™ Domain å±‚
```

### é”™è¯¯å¤„ç†ç­–ç•¥

| æ–¹æ³• | ç­–ç•¥ | åŸå›  |
|------|------|------|
| `create_journal_entry` | è¿”å›é”™è¯¯ | åˆ›å»ºæ“ä½œå¿…é¡»ä¸¥æ ¼éªŒè¯ |
| `batch_create_journal_entries` | è¿”å›é”™è¯¯ | æ‰¹é‡æ“ä½œéœ€è¦æ˜ç¡®å¤±è´¥åŸå›  |
| `simulate_journal_entry` | å¿½ç•¥æ— æ•ˆå€¼ | æ¨¡æ‹Ÿå…è®¸å®½æ¾éªŒè¯ |
| `park_journal_entry` | å¿½ç•¥æ— æ•ˆå€¼ | æš‚å­˜å…è®¸å®½æ¾éªŒè¯ |
| `validate_journal_entry` | è¿”å›è­¦å‘Š | éªŒè¯æ–¹æ³•åº”è¿”å›æ‰€æœ‰é—®é¢˜ |

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•åœºæ™¯

1. **æœ‰æ•ˆå€¼æµ‹è¯•**
   - âœ… A (ç¥¨æ®)
   - âœ… F (é¢„ä»˜æ¬¾)
   - âœ… V (é¢„æ”¶æ¬¾)
   - âœ… W (ç¥¨æ®è´´ç°)
   - âœ… ç©ºå­—ç¬¦ä¸²

2. **æ— æ•ˆå€¼æµ‹è¯•**
   - âœ… X (æ— æ•ˆå­—ç¬¦)
   - âœ… Z (æ— æ•ˆå­—ç¬¦)
   - âœ… 123 (æ•°å­—)
   - âœ… ç‰¹æ®Šå­—ç¬¦

3. **è¾¹ç•Œæµ‹è¯•**
   - âœ… null å€¼
   - âœ… ç©ºå­—ç¬¦ä¸²
   - âœ… å¤§å°å†™æ•æ„Ÿæ€§

4. **é›†æˆæµ‹è¯•**
   - âœ… åˆ›å»ºå‡­è¯
   - âœ… æ‰¹é‡åˆ›å»º
   - âœ… éªŒè¯å‡­è¯
   - âœ… æ¨¡æ‹Ÿå‡­è¯

---

## ğŸ“ˆ æ€§èƒ½å½±å“

### éªŒè¯å¼€é”€

| æ“ä½œ | é¢å¤–å¼€é”€ | è¯´æ˜ |
|------|----------|------|
| å­—ç¬¦ä¸²æ¯”è¾ƒ | < 1Î¼s | ç®€å•çš„å­—ç¬¦ä¸²åŒ¹é… |
| ç±»å‹è½¬æ¢ | < 1Î¼s | æšä¸¾è½¬æ¢ |
| é”™è¯¯æ„å»º | < 5Î¼s | ä»…åœ¨å¤±è´¥æ—¶ |
| **æ€»è®¡** | **< 10Î¼s** | **å¯å¿½ç•¥ä¸è®¡** |

### ä¼˜åŒ–æªæ–½

- âœ… ä½¿ç”¨æšä¸¾è€Œéå­—ç¬¦ä¸²æ¯”è¾ƒ
- âœ… æ—©æœŸè¿”å›ï¼ˆfail-fastï¼‰
- âœ… é¿å…ä¸å¿…è¦çš„å…‹éš†
- âœ… é›¶æˆæœ¬æŠ½è±¡

---

## ğŸ”’ å®‰å…¨æ€§

### è¾“å…¥éªŒè¯

- âœ… **ç™½åå•éªŒè¯**: åªæ¥å—é¢„å®šä¹‰çš„å€¼
- âœ… **ç±»å‹å®‰å…¨**: ä½¿ç”¨æšä¸¾è€Œéå­—ç¬¦ä¸²
- âœ… **é”™è¯¯ä¿¡æ¯**: ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯
- âœ… **é˜²æ³¨å…¥**: ä¸æ‰§è¡ŒåŠ¨æ€ä»£ç 

### é”™è¯¯å¤„ç†

- âœ… **è¯¦ç»†é”™è¯¯**: åŒ…å«è¶³å¤Ÿçš„è°ƒè¯•ä¿¡æ¯
- âœ… **ç”¨æˆ·å‹å¥½**: ä¸­æ–‡é”™è¯¯ä¿¡æ¯
- âœ… **å¯è¿½è¸ª**: åŒ…å«è¡Œå·å’Œå­—æ®µå
- âœ… **ä¸€è‡´æ€§**: ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### å†…éƒ¨æ–‡æ¡£

1. **UMSKZ_QUICK_REFERENCE.md** - å¿«é€Ÿå‚è€ƒæŒ‡å—
2. **UMSKZ_IMPLEMENTATION_SUMMARY.md** - å®æ–½æ€»ç»“
3. **UMSKZ_STAGE3_COMPLETION_REPORT.md** - Domain Model æŠ¥å‘Š

### API æ–‡æ¡£

- **Proto å®šä¹‰**: `protos/fi/gl/gl.proto`
- **Domain æ¨¡å‹**: `apps/fi/gl-service/src/domain/aggregates/journal_entry.rs`
- **gRPC Server**: `apps/fi/gl-service/src/api/grpc_server.rs`

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- âœ… æ‰€æœ‰æœ‰æ•ˆçš„ç‰¹æ®Šæ€»è´¦æ ‡è¯†éƒ½èƒ½æ­£ç¡®å¤„ç†
- âœ… æ— æ•ˆçš„ç‰¹æ®Šæ€»è´¦æ ‡è¯†è¿”å›æ˜ç¡®é”™è¯¯
- âœ… ç©ºå€¼æ­£ç¡®è½¬æ¢ä¸º None
- âœ… Domain åˆ° Proto è½¬æ¢æ­£ç¡®

### è´¨é‡éªŒæ”¶

- âœ… ä»£ç ç¼–è¯‘é€šè¿‡
- âœ… æ— ç¼–è¯‘è­¦å‘Š
- âœ… ç±»å‹å®‰å…¨
- âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°

### æ€§èƒ½éªŒæ”¶

- âœ… éªŒè¯å¼€é”€ < 10Î¼s
- âœ… æ— å†…å­˜æ³„æ¼
- âœ… æ— ä¸å¿…è¦çš„å…‹éš†

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸè®¡åˆ’

1. **é›†æˆæµ‹è¯•**
   - ç¼–å†™ç«¯åˆ°ç«¯æµ‹è¯•
   - æµ‹è¯•æ‰€æœ‰ API ç«¯ç‚¹
   - éªŒè¯é”™è¯¯å¤„ç†

2. **æ–‡æ¡£å®Œå–„**
   - æ›´æ–° API æ–‡æ¡£
   - æ·»åŠ ä½¿ç”¨ç¤ºä¾‹
   - è¡¥å……é”™è¯¯ä»£ç è¯´æ˜

3. **æ€§èƒ½æµ‹è¯•**
   - å‹åŠ›æµ‹è¯•
   - å¹¶å‘æµ‹è¯•
   - æ€§èƒ½åŸºå‡†æµ‹è¯•

### ä¸­æœŸè®¡åˆ’

1. **ç›‘æ§å’Œæ—¥å¿—**
   - æ·»åŠ éªŒè¯å¤±è´¥æ—¥å¿—
   - ç»Ÿè®¡æ— æ•ˆå€¼é¢‘ç‡
   - ç›‘æ§æ€§èƒ½æŒ‡æ ‡

2. **ç”¨æˆ·åé¦ˆ**
   - æ”¶é›†ä½¿ç”¨åé¦ˆ
   - ä¼˜åŒ–é”™è¯¯ä¿¡æ¯
   - æ”¹è¿›éªŒè¯é€»è¾‘

---

## ğŸ† æ€»ç»“

é˜¶æ®µ 5 å·²åœ†æ»¡å®Œæˆï¼æˆ‘ä»¬æˆåŠŸå®ç°äº†ï¼š

- âœ… **å®Œæ•´çš„éªŒè¯é€»è¾‘**: Proto åˆ° Domain çš„è½¬æ¢éªŒè¯
- âœ… **è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯**: ä¸­è‹±æ–‡é”™è¯¯ä¿¡æ¯ï¼ŒåŒ…å«è¡Œå·
- âœ… **ç±»å‹å®‰å…¨**: ä½¿ç”¨æšä¸¾ä¿è¯ç±»å‹å®‰å…¨
- âœ… **æ€§èƒ½ä¼˜åŒ–**: é›¶æˆæœ¬æŠ½è±¡ï¼ŒéªŒè¯å¼€é”€å¯å¿½ç•¥
- âœ… **ä»£ç è´¨é‡**: ç¼–è¯‘é€šè¿‡ï¼Œæ— è­¦å‘Š

è¯¥å®ç°æä¾›äº†ï¼š
- ğŸ¯ **ä¸¥æ ¼çš„éªŒè¯**: é˜²æ­¢æ— æ•ˆæ•°æ®è¿›å…¥ç³»ç»Ÿ
- ğŸ”’ **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶ä¿æŠ¤
- ğŸ“Š **æ¸…æ™°çš„é”™è¯¯**: ä¾¿äºè°ƒè¯•å’Œé—®é¢˜å®šä½
- ğŸš€ **é«˜æ€§èƒ½**: éªŒè¯å¼€é”€å¯å¿½ç•¥ä¸è®¡

**ğŸ‰ é˜¶æ®µ 5 - gRPC Server æ›´æ–°åœ†æ»¡å®Œæˆï¼**

---

**å®Œæˆæ—¥æœŸ**: 2026-01-18
**çŠ¶æ€**: âœ… å·²å®Œæˆ
**ä¸‹ä¸€æ­¥**: é›†æˆæµ‹è¯•å’Œæ–‡æ¡£å®Œå–„
