// ============================================================================
// /service/field-service-dispatch-service (版本 2.0)
// 描述: 管理现场服务订单的调度和执行。
//       字段设计参考核心ERP的服务订单 (类似AUFK) 和资源计划表。
// ============================================================================

syntax = "proto3";

package enterprise.service.dispatch;

option java_package = "com.enterprise.service.dispatch.v2";
option java_multiple_files = true;
option go_package = "github.com/enterprise-extensions/service/dispatch/v2;dispatch";

import "google/protobuf/timestamp.proto";
import "common/common.proto";

// ============================================================================
// 服务定义: FieldServiceDispatchService
// ============================================================================

service FieldServiceDispatchService {
  // 获取服务订单详情
  rpc GetServiceOrder(GetServiceOrderRequest) returns (ServiceOrderDetail);

  // 查询服务订单列表 (New)
  rpc ListServiceOrders(ListServiceOrdersRequest) returns (ListServiceOrdersResponse);

  // 将技术人员分配到服务订单
  rpc AssignTechnician(AssignTechnicianRequest) returns (AssignTechnicianResponse);
  
  // 取消分配 (New)
  rpc CancelAssignment(CancelAssignmentRequest) returns (AssignTechnicianResponse);
  
  // 重新调度订单 (New)
  rpc RescheduleOrder(RescheduleOrderRequest) returns (ServiceOrderDetail);

  // 更新服务订单状态
  rpc UpdateServiceOrderStatus(UpdateServiceOrderStatusRequest) returns (UpdateServiceOrderStatusResponse);
}

// ============================================================================
// 数据结构: ServiceOrder (服务订单)
// ============================================================================

// 服务订单详情
message ServiceOrderDetail {
  string order_number = 1;
  enterprise.common.ServiceOrderType order_type = 2;
  string customer_id = 3;
  enterprise.common.Address service_location = 4;
  string description = 5;
  google.protobuf.Timestamp planned_start_datetime = 6;
  string assigned_technician_id = 7;
  enterprise.common.ServiceOrderStatus status = 8;
  enterprise.common.AuditData audit_data = 9;
}

// ============================================================================
// RPC 消息定义
// ============================================================================

// 获取服务订单请求
message GetServiceOrderRequest {
  string order_number = 1;
  enterprise.common.RequestContext context = 99;
}

message ListServiceOrdersRequest {
  string technician_id = 1;
  string customer_id = 2;
  enterprise.common.DateRange date_range = 3;
  enterprise.common.ServiceOrderStatus status_filter = 4;
  enterprise.common.PaginationRequest pagination = 98;
  enterprise.common.RequestContext context = 99;
}

message ListServiceOrdersResponse {
  repeated ServiceOrderDetail orders = 1;
  enterprise.common.PaginationResponse pagination = 2;
}

// 分配技术人员请求
message AssignTechnicianRequest {
  string order_number = 1;
  string technician_id = 2;
  google.protobuf.Timestamp scheduled_datetime = 3;
  enterprise.common.RequestContext context = 99;
}

// 分配技术人员响应
message AssignTechnicianResponse {
  bool success = 1;
  repeated enterprise.common.ApiMessage messages = 2;
}

message CancelAssignmentRequest {
  string order_number = 1;
  string reason = 2;
  enterprise.common.RequestContext context = 99;
}

message RescheduleOrderRequest {
  string order_number = 1;
  google.protobuf.Timestamp new_start_datetime = 2;
  string reason = 3;
  enterprise.common.RequestContext context = 99;
}

// 更新服务订单状态请求
message UpdateServiceOrderStatusRequest {
  string order_number = 1;
  enterprise.common.ServiceOrderStatus new_status = 2;
  string notes = 3;
  enterprise.common.RequestContext context = 99;
}

// 更新服务订单状态响应
message UpdateServiceOrderStatusResponse {
  bool success = 1;
  repeated enterprise.common.ApiMessage messages = 2;
}
