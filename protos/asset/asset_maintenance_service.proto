// ============================================================================
// /asset/asset-maintenance-service (版本 2.1)
// 描述: 提供技术对象管理和维护订单的创建、执行与全生命周期管理功能。
//       字段设计深度参考核心ERP的 EQUI (设备), ILOA (位置), AUFK (订单主数据),
//       AFKO (订单抬头), AFVC (工序), RESB (组件/备件), JEST (状态) 表。
// ============================================================================

syntax = "proto3";

package enterprise.asset.maintenance;

option java_package = "com.enterprise.asset.maintenance.v2";
option java_multiple_files = true;
option go_package = "github.com/enterprise-extensions/asset/maintenance/v2;maintenance";

import "google/protobuf/timestamp.proto";
import "common/common.proto";

// ============================================================================
// 服务定义: AssetMaintenanceService
// ============================================================================

service AssetMaintenanceService {
  // --------------------------------------------------------------------------
  // 通知单 (Notification)
  // --------------------------------------------------------------------------

  // 创建维护通知单
  rpc CreateMaintenanceNotification(CreateNotificationRequest) returns (NotificationResponse);

  // 更新维护通知单
  rpc UpdateMaintenanceNotification(UpdateNotificationRequest) returns (NotificationResponse);

  // 下达维护通知单 (New)
  rpc ReleaseMaintenanceNotification(ReleaseNotificationRequest) returns (NotificationResponse);

  // 查询维护通知单列表 (New)
  rpc ListMaintenanceNotifications(ListNotificationsRequest) returns (ListNotificationsResponse);

  // --------------------------------------------------------------------------
  // 维护订单 (Maintenance Order)
  // --------------------------------------------------------------------------

  // 基于通知单或直接创建维护订单
  rpc CreateMaintenanceOrder(CreateMaintenanceOrderRequest) returns (MaintenanceOrderResponse);

  // 获取维护订单详情
  rpc GetMaintenanceOrder(GetMaintenanceOrderRequest) returns (MaintenanceOrderDetail);

  // 更新维护订单
  rpc UpdateMaintenanceOrder(UpdateMaintenanceOrderRequest) returns (MaintenanceOrderResponse);

  // 下达维护订单 (Release)
  rpc ReleaseMaintenanceOrder(ReleaseMaintenanceOrderRequest) returns (MaintenanceOrderResponse);

  // 取消维护订单 (New)
  rpc CancelMaintenanceOrder(CancelMaintenanceOrderRequest) returns (MaintenanceOrderResponse);

  // 技术性完成维护订单 (TECO)
  rpc CompleteMaintenanceOrder(CompleteMaintenanceOrderRequest) returns (MaintenanceOrderResponse);

  // 查询维护订单列表 (New)
  rpc ListMaintenanceOrders(ListOrdersRequest) returns (ListOrdersResponse);

  // --------------------------------------------------------------------------
  // 执行与确认 (Execution & Confirmation)
  // --------------------------------------------------------------------------

  // 确认维护订单工序 (报工)
  rpc ConfirmMaintenanceOperation(ConfirmMaintenanceOperationRequest) returns (ConfirmMaintenanceOperationResponse);

  // --------------------------------------------------------------------------
  // 备件/组件 (Components)
  // --------------------------------------------------------------------------

  // 获取订单组件列表
  rpc GetOrderComponents(GetOrderComponentsRequest) returns (OrderComponentsResponse);
}

// ============================================================================
// 数据结构: Maintenance (维护)
// ============================================================================

// 维护通知单 (参考: QMEL)
message MaintenanceNotification {
  string notification_number = 1;
  string notification_type = 2; // e.g. M1, M2
  string description = 3;
  string long_description = 4;
  
  string equipment_number = 5;
  string functional_location = 6;
  string assembly_material = 7;

  string reported_by = 8;
  google.protobuf.Timestamp reported_date = 9;
  
  google.protobuf.Timestamp breakdown_start_date = 10;
  google.protobuf.Timestamp breakdown_end_date = 11;
  string breakdown_duration = 12;
  string breakdown_duration_unit = 13;
  
  string priority = 14;
  enterprise.common.OrderStatus status = 15;
}

// 维护订单详情 (参考: AUFK, AFKO)
message MaintenanceOrderDetail {
  string order_number = 1;
  string order_type = 2;
  string description = 3;
  
  string notification_number = 4;
  string equipment_number = 5;
  string functional_location = 6;
  
  string maintenance_plant = 7;
  string planning_plant = 8;
  string planner_group = 9;
  string main_work_center = 10;
  
  string system_status = 11;
  string user_status = 12;
  
  string priority = 13;
  google.protobuf.Timestamp basic_start_date = 14;
  google.protobuf.Timestamp basic_finish_date = 15;
  google.protobuf.Timestamp scheduled_start_date = 16;
  google.protobuf.Timestamp scheduled_finish_date = 17;
  google.protobuf.Timestamp actual_start_date = 18;
  google.protobuf.Timestamp actual_finish_date = 19;
  
  string currency = 20;
  enterprise.common.MonetaryValue estimated_total_cost = 21;
  enterprise.common.MonetaryValue actual_total_cost = 22;
  
  repeated MaintenanceOperation operations = 23;
  repeated MaintenanceOrderComponent components = 24;
}

// 维护订单工序 (参考: AFVC)
message MaintenanceOperation {
  string operation_number = 1;
  string sub_operation_number = 2;
  
  string control_key = 3;
  string work_center = 4;
  string plant = 5;
  string description = 6;
  string long_description = 7;
  
  string planned_work_duration = 8;
  string actual_work_duration = 9;
  string work_unit = 10;
  enterprise.common.QuantityValue quantity = 11;
  
  enterprise.common.OperationStatus system_status = 13;
}

// 维护订单组件 (参考: RESB)
message MaintenanceOrderComponent {
  string item_number = 1;
  string material = 2;
  string material_description = 3;
  
  enterprise.common.QuantityValue requirement_quantity = 4;
  enterprise.common.QuantityValue withdrawn_quantity = 5;
  
  string plant = 7;
  string storage_location = 8;
  string batch = 9;
  enterprise.common.ItemCategory item_category = 10;
  google.protobuf.Timestamp requirement_date = 11;
  bool backflush_indicator = 12;
}

// ============================================================================
// RPC 消息定义
// ============================================================================

// 创建维护通知单请求
message CreateNotificationRequest {
  MaintenanceNotification notification = 1;
  enterprise.common.RequestContext context = 99;
}

// 更新维护通知单请求
message UpdateNotificationRequest {
  string notification_number = 1;
  MaintenanceNotification notification = 2;
  repeated string update_mask = 3;
  enterprise.common.RequestContext context = 99;
}

message ReleaseNotificationRequest {
  string notification_number = 1;
  enterprise.common.RequestContext context = 99;
}

// 通知单响应
message NotificationResponse {
  bool success = 1;
  string notification_number = 2;
  repeated enterprise.common.ApiMessage messages = 3;
}

message ListNotificationsRequest {
  string equipment_number = 1;
  enterprise.common.DateRange date_range = 2;
  string status_filter = 3;
  enterprise.common.PaginationRequest pagination = 98;
  enterprise.common.RequestContext context = 99;
}

message ListNotificationsResponse {
  repeated MaintenanceNotification notifications = 1;
  enterprise.common.PaginationResponse pagination = 2;
}

// 创建维护订单请求
message CreateMaintenanceOrderRequest {
  string order_type = 1;
  string description = 2;
  string reference_notification_number = 3;
  string equipment_number = 4;
  string functional_location = 5;
  string planning_plant = 6;
  enterprise.common.RequestContext context = 99;
}

// 更新维护订单请求
message UpdateMaintenanceOrderRequest {
  string order_number = 1;
  string description = 2;
  google.protobuf.Timestamp basic_start_date = 3;
  google.protobuf.Timestamp basic_finish_date = 4;
  repeated MaintenanceOperation operations = 5;
  repeated MaintenanceOrderComponent components = 6;
  enterprise.common.RequestContext context = 99;
}

// 下达维护订单请求
message ReleaseMaintenanceOrderRequest {
  string order_number = 1;
  enterprise.common.RequestContext context = 99;
}

message CancelMaintenanceOrderRequest {
  string order_number = 1;
  string cancellation_reason = 2;
  enterprise.common.RequestContext context = 99;
}

// 技术性完成订单请求
message CompleteMaintenanceOrderRequest {
  string order_number = 1;
  google.protobuf.Timestamp reference_date = 2;
  enterprise.common.RequestContext context = 99;
}

// 维护订单响应
message MaintenanceOrderResponse {
  bool success = 1;
  string order_number = 2;
  enterprise.common.OrderStatus status = 3;
  repeated enterprise.common.ApiMessage messages = 4;
}

// 获取维护订单请求
message GetMaintenanceOrderRequest {
  string order_number = 1;
  enterprise.common.RequestContext context = 99;
}

message ListOrdersRequest {
  string equipment_number = 1;
  enterprise.common.DateRange date_range = 2;
  string status_filter = 3;
  enterprise.common.PaginationRequest pagination = 98;
  enterprise.common.RequestContext context = 99;
}

message ListOrdersResponse {
  repeated MaintenanceOrderDetail orders = 1;
  enterprise.common.PaginationResponse pagination = 2;
}

// 确认维护订单工序请求
message ConfirmMaintenanceOperationRequest {
  string order_number = 1;
  string operation_number = 2;
  enterprise.common.ConfirmationType confirmation_type = 3;
  
  string actual_work_duration = 4;
  string work_unit = 5;
  enterprise.common.QuantityValue yield_quantity = 6;
  enterprise.common.QuantityValue scrap_quantity = 7; // 报废数量
  
  string confirmation_text = 8;
  bool clear_open_reservations = 9;
  google.protobuf.Timestamp posting_date = 10;
  enterprise.common.RequestContext context = 99;
}

// 确认维护订单工序响应
message ConfirmMaintenanceOperationResponse {
  bool success = 1;
  string confirmation_number = 2;
  repeated enterprise.common.ApiMessage messages = 3;
}

message GetOrderComponentsRequest {
  string order_number = 1;
  enterprise.common.RequestContext context = 99;
}

message OrderComponentsResponse {
  string order_number = 1;
  repeated MaintenanceOrderComponent components = 2;
}
