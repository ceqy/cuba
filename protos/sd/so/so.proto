// ============================================================================
// /sales/order-fulfillment-service (版本 2.0)
// 描述: 提供销售订单的创建、查询和履行状态跟踪功能。
//       字段设计参考核心ERP的 VBAK, VBAP, VBEP 表。
// ============================================================================

syntax = "proto3";

package sd.so.v1;

option go_package = "github.com/enterprise/erp/protos/sd/so;so";


import "google/protobuf/timestamp.proto";
import "common/common.proto";
import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

// ============================================================================
// 服务定义: SalesOrderFulfillmentService
// ============================================================================

service SalesOrderFulfillmentService {

  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_tag) = {
    description: "提供销售订单的创建、查询和履行状态跟踪功能。"
  };
  // 创建销售订单
  rpc CreateSalesOrder(CreateSalesOrderRequest) returns (SalesOrderResponse) {

    option (google.api.http) = {

      post: "/api/v1/sales/sales-order"

      body: "*"

    };

  }
  
  // 更新销售订单 (New)
  rpc UpdateSalesOrder(UpdateSalesOrderRequest) returns (SalesOrderResponse) {

  
    option (google.api.http) = {

  
      put: "/api/v1/sales/sales-order"

  
      body: "*"

  
    };

  
  }
  
  // 取消销售订单 (New)
  rpc CancelSalesOrder(CancelSalesOrderRequest) returns (SalesOrderResponse) {

  
    option (google.api.http) = {

  
      post: "/api/v1/sales/sales-order/cancel"

  
      body: "*"

  
    };

  
  }

  // 获取销售订单详情
  rpc GetSalesOrder(GetSalesOrderRequest) returns (SalesOrderDetail) {


    option (google.api.http) = {


      get: "/api/v1/sales/sales-order"


    };


  }

  // 查询销售订单列表
  rpc ListSalesOrders(ListSalesOrdersRequest) returns (ListSalesOrdersResponse) {


    option (google.api.http) = {


      get: "/api/v1/sales/sales-orders"


    };


  }

  // 获取销售订单的履行状态 (凭证流)
  rpc GetSalesOrderFulfillmentStatus(GetSalesOrderRequest) returns (FulfillmentStatusResponse) {


    option (google.api.http) = {


      get: "/api/v1/sales/sales-order-fulfillment-status"


    };


  }
}

// ============================================================================
// 数据结构: SalesOrder (销售订单)
// ============================================================================

// 销售订单抬头 (参考: VBAK)
message SalesOrderHeader {
  common.v1.OrderType order_type = 1;
  string sales_org = 2;
  string distribution_channel = 3;
  string division = 4;
  string sold_to_party = 5;
  string ship_to_party = 6;
  string customer_po = 7;
  google.protobuf.Timestamp customer_po_date = 8;
  google.protobuf.Timestamp document_date = 9;
  google.protobuf.Timestamp requested_delivery_date = 10;
  string currency = 11;
  string pricing_procedure = 12;
  string shipping_conditions = 13;
  string delivery_block = 14;
  string billing_block = 15;
}

// 销售订单行项目 (参考: VBAP)
message SalesOrderItem {
  int32 item_number = 1;
  string material = 2;
  string item_description = 3;
  string order_quantity = 4;
  string sales_unit = 5;
  string plant = 6;
  string storage_location = 7;
  string net_value = 8;
  string tax_amount = 9;
  common.v1.ItemCategory item_category = 10;
  string rejection_reason = 11;
  int32 higher_level_item = 12;
}

// 销售订单计划行 (参考: VBEP)
message SalesOrderScheduleLine {
    int32 schedule_line_number = 1;
    google.protobuf.Timestamp delivery_date = 2;
    string confirmed_quantity = 3;
}

// 完整的销售订单详情
message SalesOrderDetail {
  string order_number = 1;
  SalesOrderHeader header = 2;
  repeated SalesOrderItem items = 3;
  repeated SalesOrderScheduleLine schedule_lines = 4;
  common.v1.AuditData audit_data = 5;
  common.v1.OrderStatus overall_status = 6;
}

// ============================================================================
// RPC 消息定义
// ============================================================================

// 创建销售订单请求
message CreateSalesOrderRequest {
  SalesOrderHeader header = 1;
  repeated SalesOrderItem items = 2;
  common.v1.RequestContext context = 99;
}

message UpdateSalesOrderRequest {
  string order_number = 1;
  SalesOrderHeader header = 2;
  repeated SalesOrderItem items = 3;
  repeated string update_mask = 4;
  common.v1.RequestContext context = 99;
}

message CancelSalesOrderRequest {
  string order_number = 1;
  string cancellation_reason = 2;
  common.v1.RequestContext context = 99;
}

// 销售订单响应
message SalesOrderResponse {
  bool success = 1;
  string order_number = 2;
  repeated common.v1.ApiMessage messages = 3;
}

// 获取销售订单请求
message GetSalesOrderRequest {
  string order_number = 1;
  common.v1.RequestContext context = 99;
}

// 查询销售订单请求
message ListSalesOrdersRequest {
  string sold_to_party = 1;
  string material = 2;
  common.v1.DateRange document_date_range = 3;
  common.v1.OrderType order_type = 4;
  common.v1.OrderStatus status = 6;
  common.v1.PaginationRequest pagination = 5;
  common.v1.RequestContext context = 99;
}

// 查询销售订单响应
message ListSalesOrdersResponse {
  repeated SalesOrderSummary orders = 1;
  common.v1.PaginationResponse pagination = 2;
}

// 销售订单摘要
message SalesOrderSummary {
  string order_number = 1;
  common.v1.OrderType order_type = 2;
  google.protobuf.Timestamp document_date = 3;
  string sold_to_party = 4;
  common.v1.MonetaryValue net_value = 5;
  common.v1.OrderStatus overall_status = 6;
}

// 凭证流响应
message FulfillmentStatusResponse {
  string root_document_number = 1;
  repeated DocumentFlowNode nodes = 2;
}

// 凭证流节点
message DocumentFlowNode {
  int32 node_id = 1;
  int32 parent_id = 2;
  common.v1.SystemDocumentReference document = 3;
  string description = 4;
  google.protobuf.Timestamp creation_date = 5;
}
