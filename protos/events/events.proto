// ============================================================================
// /events/events.proto (版本 2.2 - Production Ready)
// 描述: 定义跨微服务通信的业务事件，遵循 CloudEvents 1.0 规范。
//       整合了 Finance, SC, Manufacturing, Asset, HR 等全域事件。
// ============================================================================

syntax = "proto3";

package enterprise.events;

option java_package = "com.enterprise.events.v2";
option java_multiple_files = true;
option go_package = "github.com/enterprise-extensions/events/v2;events";

import "google/protobuf/timestamp.proto";
import "common/common.proto";
// import "validate/validate.proto"; // 如果环境支持 PGV，可取消注释

// ============================================================================
// CloudEvents 1.0 包装器
// ============================================================================

message CloudEvent {
  string specversion = 1; // "1.0"
  string id = 2;
  string source = 3;      // urn:service:{domain}.{service}
  string type = 4;        // enterprise.{domain}.{entity}.{action}Event
  google.protobuf.Timestamp time = 5;
  string subject = 6;
  string datacontenttype = 7; // "application/protobuf"
  string dataschema = 8;
  string event_version = 9;   // Semver
  
  // Tracing
  string trace_id = 10;
  string span_id = 11;
  string correlation_id = 12;
  
  // Tenant
  string tenant_id = 13;
  
  map<string, string> extensions = 14;

  // Payload OneOf
  oneof data {
    // Finance (00-19)
    JournalEntryPostedEvent journal_entry_posted = 20;
    InvoicePostedEvent invoice_posted = 21; // New
    
    // Procurement (20-39)
    PurchaseOrderReleasedEvent purchase_order_released = 22; // New

    // Sales (40-59)
    SalesOrderCreatedEvent sales_order_created = 23; // New
    
    // Inventory/SCM
    StockChangedEvent stock_changed = 24; // New

    // Manufacturing (50-69)
    ProductionOrderReleasedEvent production_order_released = 25; // New
    UsageDecisionMadeEvent usage_decision_made = 26;

    // Asset Management (60-79)
    MaintenanceNotificationCreatedEvent maintenance_notification_created = 27;
    MaintenanceOrderReleasedEvent maintenance_order_released = 28;

    // HR (80-89)
    EmployeeSurveyCompletedEvent employee_survey_completed = 80;
    
    // Service (90-99)
    ServiceOrderCompletedEvent service_order_completed = 81;
  }
}

// ============================================================================
// 1. Finance Domain Events
// ============================================================================

// 总账凭证已过账
message JournalEntryPostedEvent {
  string company_code = 1;
  string fiscal_year = 2;
  string document_number = 3;
  google.protobuf.Timestamp posting_date = 4;
  enterprise.common.MonetaryValue total_debit = 5;
  enterprise.common.MonetaryValue total_credit = 6;
}

// 发票已过账
message InvoicePostedEvent {
  string company_code = 1;
  string invoice_number = 2;
  string fiscal_year = 3;
  string customer_or_vendor_id = 4; // Check prefix (C/V) or context
  enterprise.common.MonetaryValue invoice_amount = 5;
  google.protobuf.Timestamp posting_date = 6;
  string invoice_type = 7; // "AR_INVOICE" or "AP_INVOICE"
}

// ============================================================================
// 2. Procurement Domain Events
// ============================================================================

// 采购订单已下达
message PurchaseOrderReleasedEvent {
  string purchase_order_number = 1;
  string vendor_id = 2;
  google.protobuf.Timestamp order_date = 3;
  enterprise.common.MonetaryValue total_value = 4;
  string purchasing_org = 5;
  string company_code = 6;
}

// ============================================================================
// 3. Sales Domain Events
// ============================================================================

// 销售订单已创建
message SalesOrderCreatedEvent {
  string sales_order_number = 1;
  string sold_to_party = 2;
  google.protobuf.Timestamp order_date = 3;
  enterprise.common.MonetaryValue net_value = 4;
  string sales_org = 5;
  enterprise.common.OrderType order_type = 6;
}

// ============================================================================
// 4. Supply Chain / Inventory Events
// ============================================================================

// 库存变更 (GR/GI/Transfer)
message StockChangedEvent {
  string material = 1;
  string plant = 2;
  string storage_location = 3;
  string batch = 4;
  enterprise.common.MovementType movement_type = 5;
  enterprise.common.QuantityValue quantity = 6;
  string material_document = 7;
  google.protobuf.Timestamp posting_date = 8;
}

// ============================================================================
// 5. Manufacturing Domain Events
// ============================================================================

// 生产订单已下达
message ProductionOrderReleasedEvent {
  string order_number = 1;
  string material = 2;
  string plant = 3;
  enterprise.common.QuantityValue target_quantity = 4;
  google.protobuf.Timestamp scheduled_start = 5;
  google.protobuf.Timestamp scheduled_finish = 6;
}

// 质量使用决策已做出
message UsageDecisionMadeEvent {
  string inspection_lot_number = 1;
  enterprise.common.InspectionLotOrigin lot_origin = 2;
  enterprise.common.UsageDecision decision_code = 3;
  string made_by = 4;
  google.protobuf.Timestamp decision_time = 5;
  string plant = 6;
  string reference_document = 7;
}

// ============================================================================
// 6. Asset Management Events
// ============================================================================

// 维护通知已创建
message MaintenanceNotificationCreatedEvent {
  string notification_number = 1;
  string notification_type = 2; // "M1", "M2"
  string equipment_number = 3;
  string description = 4;
  enterprise.common.MaintenancePriority priority = 5;
}

// 维护订单已下达
message MaintenanceOrderReleasedEvent {
  string order_number = 1;
  string order_type = 2;
  string equipment_number = 3;
  string description = 4;
  google.protobuf.Timestamp scheduled_start_date = 5;
  string released_by = 6;
}

// ============================================================================
// 7. HR Domain Events
// ============================================================================

// 员工调查已完成
message EmployeeSurveyCompletedEvent {
  string survey_id = 1;
  string employee_id = 2;
  google.protobuf.Timestamp completion_time = 3;
  float average_score = 4;
}

// ============================================================================
// 8. Service Domain Events
// ============================================================================

// 服务订单已完成
message ServiceOrderCompletedEvent {
  string order_number = 1;
  string technician_id = 2;
  google.protobuf.Timestamp completion_time = 3;
  string customer_id = 4;
  enterprise.common.ServiceOrderStatus final_status = 5;
}
