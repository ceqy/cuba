// ============================================================================
// /rd/project-cost-controlling-service (版本 2.0)
// 描述: 管理研发项目的成本和预算。
//       字段设计参考核心ERP的项目系统 (PS) 模块表结构 (例如, PRPS, COSP, COSS)。
// ============================================================================

syntax = "proto3";

package enterprise.rd.projectcost;

option java_package = "com.enterprise.rd.projectcost.v2";
option java_multiple_files = true;
option go_package = "github.com/enterprise-extensions/rd/projectcost/v2;projectcost";

import "google/protobuf/timestamp.proto";
import "common/common.proto";

// ============================================================================
// 服务定义: ProjectCostControllingService
// ============================================================================

service ProjectCostControllingService {
  // 创建项目预算 (New)
  rpc CreateProjectBudget(CreateBudgetRequest) returns (BudgetResponse);

  // 获取项目/WBS元素的成本报告
  rpc GetProjectCostReport(GetProjectCostReportRequest) returns (ProjectCostReport);
  
  // 查询项目成本列表 (New)
  rpc ListProjectCosts(ListProjectCostsRequest) returns (ListProjectCostsResponse);

  // 为项目/WBS元素过账直接成本 - 异步
  rpc PostDirectCost(PostDirectCostRequest) returns (enterprise.common.JobInfo);
  
  // 更新成本记录 (New)
  rpc UpdateCost(UpdateCostRequest) returns (PostDirectCostResponse);
}

// ============================================================================
// 数据结构: ProjectCost (项目成本)
// ============================================================================

// 项目成本报告
message ProjectCostReport {
  string project_or_wbs_element = 1;
  string description = 2;
  enterprise.common.MonetaryValue planned_cost = 3;
  enterprise.common.MonetaryValue actual_cost = 4;
  enterprise.common.MonetaryValue commitment_cost = 5;
  enterprise.common.MonetaryValue budget = 6;
  enterprise.common.MonetaryValue available_amount = 7;
  repeated CostDetailItem cost_details = 8;
  enterprise.common.BudgetStatus budget_status = 9;
}

// 成本明细项
message CostDetailItem {
  enterprise.common.CostElementType cost_element_type = 1;
  string cost_element = 2; // GL Account or Cost Element Key
  string cost_element_description = 3;
  enterprise.common.MonetaryValue amount = 4;
  google.protobuf.Timestamp posting_date = 5;
  string reference_document = 6;
  string text = 7;
}

// ============================================================================
// RPC 消息定义
// ============================================================================

message CreateBudgetRequest {
  string project_or_wbs_element = 1;
  enterprise.common.MonetaryValue amount = 2;
  string fiscal_year = 3;
  string version = 4;
  enterprise.common.RequestContext context = 99;
}

message BudgetResponse {
  bool success = 1;
  string document_number = 2;
  repeated enterprise.common.ApiMessage messages = 3;
}

// 获取项目成本报告请求
message GetProjectCostReportRequest {
  string project_or_wbs_element = 1;
  bool drilldown = 2;
  enterprise.common.RequestContext context = 99;
}

message ListProjectCostsRequest {
  string project_definition = 1;
  enterprise.common.DateRange date_range = 2;
  enterprise.common.CostElementType type_filter = 3;
  enterprise.common.PaginationRequest pagination = 98;
  enterprise.common.RequestContext context = 99;
}

message ListProjectCostsResponse {
  repeated CostDetailItem costs = 1;
  enterprise.common.PaginationResponse pagination = 2;
}

// 过账直接成本请求
message PostDirectCostRequest {
  string wbs_element = 1;
  string cost_element = 2;
  enterprise.common.CostElementType cost_element_type = 3;
  enterprise.common.MonetaryValue amount = 4;
  google.protobuf.Timestamp posting_date = 5;
  string text = 6;
  enterprise.common.RequestContext context = 99;
}

message UpdateCostRequest {
  string document_number = 1;
  enterprise.common.MonetaryValue new_amount = 2;
  string reason_code = 3;
  enterprise.common.RequestContext context = 99;
}

// 过账直接成本响应
message PostDirectCostResponse {
  bool success = 1;
  string accounting_document_number = 2;
  repeated enterprise.common.ApiMessage messages = 3;
}
